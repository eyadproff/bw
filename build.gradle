import org.apache.tools.ant.filters.ReplaceTokens

buildscript {
    repositories {
        flatDir {
            dirs "libs/build"
        }
    }
    dependencies {
        classpath name: 'jsch-0.1.54'
        classpath name: 'groovy-ssh-2.9.0'
        classpath name: 'gradle-ssh-plugin-2.9.0'
    }
}

project.version = '1.1.3'
group = 'sa.gov.nic.bio'

apply plugin: 'java'
apply plugin: "org.hidetake.ssh"

sourceCompatibility = 1.8
targetCompatibility = 1.8

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

repositories {
    flatDir {
        dirs "libs/compile"
        dirs "libs/provided"
    }
}

dependencies {
    implementation name: "activation-1.1.1"
    implementation name: "activiti-bpmn-converter-6.0.0"
    implementation name: "activiti-bpmn-model-6.0.0"
    implementation name: "activiti-dmn-api-6.0.0"
    implementation name: "activiti-dmn-model-6.0.0"
    implementation name: "activiti-engine-6.0.0"
    implementation name: "activiti-form-api-6.0.0"
    implementation name: "activiti-form-model-6.0.0"
    implementation name: "activiti-image-generator-6.0.0"
    implementation name: "activiti-process-validation-6.0.0"
    implementation name: "commons-email-1.5"
    implementation name: "commons-lang3-3.6"
    implementation name: "commons-logging-1.2"
    implementation name: "controlsfx-8.40.14"
    implementation name: "h2-1.4.196"
    implementation name: "javax.mail-api-1.6.0"
    implementation name: "joda-time-2.9.9"
    implementation name: "juel-api-2.2.7"
    implementation name: "juel-impl-2.2.7"
    implementation name: "juel-spi-2.2.7"
    implementation name: "mybatis-3.4.4"
    implementation name: "okhttp-3.8.1"
    implementation name: "okio-1.13.0"
    implementation name: "retrofit-2.3.0"
    implementation name: "slf4j-api-1.7.25"
    /*implementation name: "slf4j-jdk14-1.7.25"*/
    implementation name: "slf4j-nop-1.7.25"
    implementation name: "converter-jackson-2.3.0"
    implementation name: "jackson-annotations-2.9.0"
    implementation name: "jackson-core-2.9.0"
    implementation name: "jackson-databind-2.9.0"
    testImplementation name: "junit-4.12"
}

processResources {
    filesMatching('**/config.properties') {
        def env = System.getenv('build-environemnt')
        println 'build-environment = ' + env

        filter(ReplaceTokens, tokens:['APP_VERSION': project.version])

        /*if(env == 'INT') filter(ReplaceTokens, tokens:['APP_VERSION': project.version + '-SNAPSHOT' + new Date().format('yyyyMMddHHmmss')])
        else if(env == 'PROD') filter(ReplaceTokens, tokens:['APP_VERSION': project.version])
        else *//*(DEV)*//* filter(ReplaceTokens, tokens:['APP_VERSION': project.version + '-DEV'])*/
    }
}

jar {
    manifest {
        attributes('Implementation-Title': project.name,
                'Implementation-Version': project.version,
                'Implementation-Vendor': 'NIC',
                'Application-Name': 'Biometrics Workstation',
                'Built-By': 'Biometrics Team',
                'JavaFX-Preloader-Class': 'sa.gov.nic.bio.bw.client.preloader.AppPreloader',
                'JavaFX-Application-Class': 'sa.gov.nic.bio.bw.client.AppEntryPoint',
                'Main-Class': 'sa.gov.nic.bio.bw.client.AppEntryPoint',
                'Class-Path': configurations.runtimeClasspath.files.collect { it.getName() }.join(' '))
    }
}

task collectDependencies(type: Copy) {
    from configurations.runtimeClasspath.files
    into 'build/libs'
}
collectDependencies.dependsOn(jar)

task packageWebStart(group: 'web-start') {
    doLast {

        String jnlpTemplate = new File("build-resources/bw-template.jnlp").getText('UTF-8')

        // add JNLP properties to the JNLP file
        def sProperties = StringBuilder.getDeclaredConstructor().newInstance()
        boolean first = true;
        Properties properties = new Properties()
        InputStream inputStream = new FileInputStream("src/main/resources/sa/gov/nic/bio/bw/client/core/config/jnlp.properties")
        properties.load(inputStream)
        inputStream.close()
        for(Object key : Collections.list(properties.propertyNames()))
        {
            String sKey = (String) key;
            String value = properties.getProperty(sKey);

            if(first) first = false
            else sProperties << '\n        '

            sProperties << '<property name="' + sKey + '" value="' + value + '"/>'
        }

        jnlpTemplate = jnlpTemplate.replace('<!--PROPERTIES PLACE HOLDER-->', sProperties)

        File directory = new File("${projectDir}/build/web-start")
        directory.mkdirs()
        File file = new File(directory, 'APPLICATION.JNLP')
        file.createNewFile()
        file.text = jnlpTemplate

        // copy jar files
        copy {
            from 'build/libs'
            into "build/web-start/jars"
        }
    }
}
packageWebStart.dependsOn(collectDependencies)

task run(type: JavaExec, group: 'run') {
    main = "-jar" // workaround to "java -jar file.jar"
    args = [jar.archivePath.absolutePath]
}
run.dependsOn(collectDependencies)


remotes {
    webServer {
        host = '10.0.73.50'
        user = 'root'
        identity = file('build-resources/integration_server_id_rsa')
    }
}

task packageWebStartAndDeploy(group: 'web-start') {
    doLast {
        ssh.run {
            session(remotes.webServer) {
                remove '/home/user/Desktop/wlp/usr/servers/bio-client-downloader/dropins/bw'
                execute 'mkdir /home/user/Desktop/wlp/usr/servers/bio-client-downloader/dropins/bw'
                put from: new File('build/web-start').listFiles().toList(), into: '/home/user/Desktop/wlp/usr/servers/bio-client-downloader/dropins/bw'
            }
        }
    }
}
packageWebStartAndDeploy.dependsOn(packageWebStart)

task deploy(group: 'web-start') {
    doLast {
        ssh.run {
            session(remotes.webServer) {
                remove '/home/user/Desktop/wlp/usr/servers/bio-client-downloader/dropins/bw'
                execute 'mkdir /home/user/Desktop/wlp/usr/servers/bio-client-downloader/dropins/bw'
                put from: new File('build/web-start').listFiles().toList(), into: '/home/user/Desktop/wlp/usr/servers/bio-client-downloader/dropins/bw'
            }
        }
    }
}